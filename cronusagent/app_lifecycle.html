
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Application Lifecycle &#8212; cronus 0.1.45 documentation</title>
    
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1.45',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Application Lifecycle Scripts" href="app_lcm_scripts.html" />
    <link rel="prev" title="Install in IaaS Cloud" href="install_cloud.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="app_lcm_scripts.html" title="Application Lifecycle Scripts"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="install_cloud.html" title="Install in IaaS Cloud"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">cronus 0.1.45 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Cronus Agent</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="application-lifecycle">
<h1>Application Lifecycle<a class="headerlink" href="#application-lifecycle" title="Permalink to this headline">¶</a></h1>
<p>This section describes application lifecycle defined by Cronus framework.</p>
<div class="section" id="terminology">
<h2>Terminology<a class="headerlink" href="#terminology" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Service: an application, one or more instances serving the same function and code.</li>
<li>Manifest: a version of an application, composed of one or more packages. Multiple manifests may be deployed to a ServiceInstance, but only one can be active at a time.</li>
<li>Active Manifest: a manifest actively in use.</li>
<li>Package: the smallest unit of deployment that Cronus understands. It can be a tarball containing application runtime, code, config, and cronus structure required for deployment.</li>
<li>Cronus Package: a cronus structure that is zip-tarred as a {service}-{version}.{platform}.cronus package.</li>
<li>ServiceInstance - is a single instance of a service, typically mapped to a single compute.</li>
</ul>
</div>
<div class="section" id="application-hierarchy">
<h2>Application Hierarchy<a class="headerlink" href="#application-hierarchy" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><dl class="first docutils">
<dt>A service have one or many manifests, among which, 0 or 1 active manifest, one manifest can have one or many cronus packages</dt>
<dd>service (1) –&gt; (1..n) manifests (1) –&gt; (1..n) packages
service (1) –&gt; (0..1) active_manifest_x</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>A service deployed in cloud have one or many compute, each deployed with the active manifest of the same version</dt>
<dd>service_deployed_in_cloud –&gt; (1..n) service_instances (1) –&gt; active_manifest_x</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="application-life-cycle">
<h2>Application Life Cycle<a class="headerlink" href="#application-life-cycle" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Service lifecycle: Service can be created on a compute, and later can be deleted if no active manifest presents.</li>
<li>Manifest lifecycle: Manifest can be created on a compute for a particular service, activate a manifest will deactivating any existing active manifest and make the manifest active manifest, active manifest can be startup, shutdown, and restart, active manifest can be deactivated and then deleted.</li>
</ul>
</div>
<div class="section" id="application-package-structure-aka-cronus-package">
<h2>Application Package Structure (aka Cronus Package)<a class="headerlink" href="#application-package-structure-aka-cronus-package" title="Permalink to this headline">¶</a></h2>
<ul>
<li><dl class="first docutils">
<dt>Cronus Package</dt>
<dd><p class="first">All packages within an application manifest need to be packaged with certain structure and provide a set of life cycle scripts</p>
<div class="last highlight-bash"><div class="highlight"><pre><span></span>package_root/              <span class="c1"># package root directory</span>
    cronus/                <span class="c1"># cronus directory</span>
        cronus.prop        <span class="c1"># prop file describe the package</span>
        cronus.ini         <span class="c1"># configuration file in json format to customize agent behavior</span>
        scripts/           <span class="c1"># optional scripts directory containing package scripts</span>
            install        <span class="c1"># execute when package is untarred the first time, executed once only during package life time.</span>
            activate       <span class="c1"># execute when parent manifest has been set active.</span>
            startup        <span class="c1"># execute to &#39;start&#39; a package</span>
            running        <span class="c1"># execute to check package runtime state</span>
            shutdown       <span class="c1"># execute to &#39;shut down&#39; a package</span>
            deactivate     <span class="c1"># execute when parent manifest gets deactivated</span>
    ...                    <span class="c1"># any application files or directories to be packaged</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><p class="first">Cronus package deployed on compute</p>
<blockquote>
<div><div class="highlight-bash"><div class="highlight"><pre><span></span>/path_to_service_home/<span class="o">{</span>service<span class="o">}</span>     <span class="c1"># service root directory</span>
   .metadata.json                   <span class="c1"># metadata json file</span>
   .appdata/                        <span class="c1"># application data directory, shared among manifests</span>
   manifests/                       <span class="c1"># application manifests</span>
      active                        <span class="c1"># symlink point to active manifest</span>
      <span class="m">1</span>.0.0/                        <span class="c1"># manifest 1.0.0</span>
         pkg1                       <span class="c1"># inflated cronus package1</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><dl class="first docutils">
<dt>Naming Convention</dt>
<dd><p class="first last">Tarred cronus package has to follow the naming convention of “{packageName}-{majorVersion}.{minorVersion}.{incrementalVersion}.[optionalVersionSuffix].{platform}.cronus”, e.g. agent-1.0.0.x86_ubuntu.cronus
An optional corresponding property file that specify metadata of the cronus package, most importantly md5 checksum of the cronus package, property file has to follow the naming convention of “{sameCronusPackageName}.prop”, e.g. PortalWebAppConfiguration-1.0.0.unix.cronus.prop, for example</p>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="application-life-cycle-management">
<h2>Application Life Cycle Management<a class="headerlink" href="#application-life-cycle-management" title="Permalink to this headline">¶</a></h2>
<p><strong>Life Cycle Management Scripts</strong></p>
<blockquote>
<div><p>Agent requires a set of LCM scripts in order to control the application life cycle precisely</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="14%" />
<col width="72%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Script</td>
<td>Required</td>
<td>Description</td>
</tr>
<tr class="row-even"><td>install</td>
<td>optional</td>
<td>additional installation operations after software package
is uncompressed and manifest created run only once
within manifest life time</td>
</tr>
<tr class="row-odd"><td>activate</td>
<td>optional</td>
<td>activate manifest run once every time manifest is
activated, or reset</td>
</tr>
<tr class="row-even"><td>startup</td>
<td>required</td>
<td>start the application run once every time application is
activated, startup, restart, or reset</td>
</tr>
<tr class="row-odd"><td>shutdown</td>
<td>optional</td>
<td>shutdown the application run once every time application is
activated, shutdown, restart, or reset</td>
</tr>
<tr class="row-even"><td>deactivate</td>
<td>optional</td>
<td>deactivate the application run once every time manifest is
activated, or reset</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>Because application startup script is called by a process launched by agent, one must make sure that</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>Startup script returns without blocking</li>
<li>Fork the application process to a separate process</li>
<li>Detach the application process from its parent process, use setsid() to make the new process new group leader so that it does not terminate when agent process shutdown/restart. For more details see <a class="reference external" href="http://stackoverflow.com/questions/2613104/why-fork-before-setsid">http://stackoverflow.com/questions/2613104/why-fork-before-setsid</a></li>
</ul>
</div></blockquote>
<p><strong>Passing Parameters</strong></p>
<ul class="simple">
<li>Default environment variables: agent injects the following environment variables to application before invoking application life cycle scripts<ul>
<li>$CRONUSAPP_HOME: absolute path to the application service root directory</li>
<li>$LCM_CORRELATIONID: correctionid if any passed for the LCM API</li>
</ul>
</li>
<li>Additional environment variables: any additional parameters passed in through agent deploy API are made available to LCM scripts as environment variables</li>
</ul>
<p><strong>Timeouts and Passing Information to Agent</strong></p>
<ul>
<li><p class="first">Timeout: Scripts must exit before timeout expires, or process be killed, default timeout is 15 minutes configurable by agent config.</p>
</li>
<li><p class="first">Progress Timeout: Scripts must demonstrate progress (progress number increasing) by passing progress information to agent or process be killed, default progress timeout is 1 minute configurable by agent config.</p>
</li>
<li><p class="first">Passing Information to Agent while Running: Scripts can pass progress and other information to agent via stdout while running, in syntax</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="p">[</span><span class="nx">AGENT_MESSAGE</span><span class="p">]</span>
<span class="p">{</span>
    <span class="s2">&quot;progress&quot;</span><span class="o">:</span> <span class="mi">50</span><span class="p">,</span>
<span class="p">}</span>
<span class="p">[</span><span class="nx">AGENT_MESSAGE_END</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p class="first">Passing Result to Agent at Exit: Scripts can pass result to agent via its return code and stdout.</p>
<ul>
<li><p class="first">0: success</p>
</li>
<li><p class="first">Any non-zero return code: failure</p>
</li>
<li><p class="first">Additional information including status, progress, and message can be passed to agent via stdout, in syntax</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="c1">// simple report progress increments</span>
<span class="p">[</span><span class="nx">AGENT_MESSAGE</span><span class="p">]</span> <span class="o">+</span><span class="mf">1.0</span> <span class="p">[</span><span class="nx">AGENT_MESSAGE_END</span><span class="p">]</span>

<span class="c1">// simple report progress</span>
<span class="p">[</span><span class="nx">AGENT_MESSAGE</span><span class="p">]</span> <span class="mf">50.0</span> <span class="p">[</span><span class="nx">AGENT_MESSAGE_END</span><span class="p">]</span>

<span class="c1">// sample message to agent for successful completion</span>
<span class="p">[</span><span class="nx">AGENT_MESSAGE</span><span class="p">]</span>
<span class="p">{</span>
  <span class="s2">&quot;progress&quot;</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span>
  <span class="s2">&quot;result&quot;</span><span class="o">:</span><span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="p">{</span><span class="nx">result_key</span><span class="p">},</span> <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="p">{</span><span class="nx">result_value</span><span class="p">}}</span>
  <span class="p">]</span>
<span class="p">}</span>
<span class="p">[</span><span class="nx">AGENT_MESSAGE_END</span><span class="p">]</span>

<span class="c1">// sample message to agent for error</span>

<span class="p">[</span><span class="nx">AGENT_MESSAGE</span><span class="p">]</span>
<span class="p">{</span>
  <span class="s2">&quot;error&quot;</span><span class="o">:</span> <span class="p">{</span><span class="nx">error_code</span><span class="p">},</span>
  <span class="s2">&quot;errorMsg&quot;</span><span class="o">:</span> <span class="p">{</span><span class="nx">error_message</span><span class="p">},</span>
  <span class="s2">&quot;result&quot;</span><span class="o">:</span><span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="p">{</span><span class="nx">result_key</span><span class="p">},</span> <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="p">{</span><span class="nx">result_value</span><span class="p">}}</span>
  <span class="p">]</span>
<span class="p">}</span>
<span class="p">[</span><span class="nx">AGENT_MESSAGE_END</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p class="first">Stdout or Stderr: while executing application script, agent reads from stdout and process any message matches the above format and use it to update status. If script fails with non-zero return code, agent reads from stderr, or if it is missing, from last readout from stdout, for anything matches the above format and update error status. Both status can be retrieved from agent status API “/status/:uuid”</p>
</li>
<li><p class="first">Mutli-line support: with single-line output, [AGENT_MESSAGE_END] can be omitted. With mutli-line output, agent looks for [AGENT_MESSAGE_END] as end of message indicator, there is a limit of 8k for agent message</p>
</li>
<li><p class="first">Encoding: only ascii is supported, other encoding will be skipped</p>
</li>
</ul>
</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Application Lifecycle</a><ul>
<li><a class="reference internal" href="#terminology">Terminology</a></li>
<li><a class="reference internal" href="#application-hierarchy">Application Hierarchy</a></li>
<li><a class="reference internal" href="#application-life-cycle">Application Life Cycle</a></li>
<li><a class="reference internal" href="#application-package-structure-aka-cronus-package">Application Package Structure (aka Cronus Package)</a></li>
<li><a class="reference internal" href="#application-life-cycle-management">Application Life Cycle Management</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="install_cloud.html"
                        title="previous chapter">Install in IaaS Cloud</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="app_lcm_scripts.html"
                        title="next chapter">Application Lifecycle Scripts</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/cronusagent/app_lifecycle.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="app_lcm_scripts.html" title="Application Lifecycle Scripts"
             >next</a> |</li>
        <li class="right" >
          <a href="install_cloud.html" title="Install in IaaS Cloud"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">cronus 0.1.45 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Cronus Agent</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2014, binyu.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.2.
    </div>
  </body>
</html>